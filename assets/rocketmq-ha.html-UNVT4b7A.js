import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,f as e,o as t}from"./app-Cp6Zyva7.js";const r="/assets/img-BL22rC4W.png",l="/assets/img_1-CuWOLQ9Z.png",o={};function p(i,n){return t(),s("div",null,[...n[0]||(n[0]=[e(`<h3 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h3><p>本部分主要介绍如何部署自动容灾切换的 RocketMQ-on-DLedger Group。</p><p>RocketMQ-on-DLedger Group 是指一组相同名称的 Broker，至少需要 3 个节点，通过 Raft 自动选举出一个 Leader，其余节点 作为 Follower，并在 Leader 和 Follower 之间复制数据以保证高可用。 RocketMQ-on-DLedger Group 能自动容灾切换，并保证数据一致。 RocketMQ-on-DLedger Group 是可以水平扩展的，也即可以部署任意多个 RocketMQ-on-DLedger Group 同时对外提供服务。</p><h3 id="_1-下载apache-rocketmq" tabindex="-1"><a class="header-anchor" href="#_1-下载apache-rocketmq" aria-hidden="true">#</a> 1. 下载Apache RocketMQ</h3><p>这里以在Linux环境下利用社区4.9.3的二进制包为例，介绍RocketMQ安装过程。下载地址为： https://dist.apache.org/repos/dist/release/rocketmq/4.9.3/rocketmq-all-4.9.3-bin-release.zip</p><p>解压安装包：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">unzip</span> rocketmq-all-4.9.3-bin-release.zip
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-快速部署" tabindex="-1"><a class="header-anchor" href="#_2-快速部署" aria-hidden="true">#</a> 2. 快速部署</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> rocketmq-all-4.9.3-bin-release
<span class="token function">sh</span> bin/dledger/fast-try.sh start
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果上面的步骤执行成功，可以通过 mqadmin 运维命令查看集群状态。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sh</span> bin/mqadmin clusterList <span class="token parameter variable">-n</span> <span class="token number">127.0</span>.0.1:9876
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="`+r+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_3-双中心dledger集群搭建" tabindex="-1"><a class="header-anchor" href="#_3-双中心dledger集群搭建" aria-hidden="true">#</a> 3. 双中心DLedger集群搭建</h3><h4 id="_3-1-编写配置" tabindex="-1"><a class="header-anchor" href="#_3-1-编写配置" aria-hidden="true">#</a> 3.1 编写配置</h4><p>每个 RocketMQ-on-DLedger Group 至少准备三台机器，双中心的话则需要六台机器。 编写 6 个配置文件，建议参考 conf/dledger目录下的配置文件样例。 关键配置介绍：</p><table><thead><tr><th>name</th><th>含义</th><th>举例</th></tr></thead><tbody><tr><td>enableDLegerCommitLog</td><td>是否启动DLeger</td><td>true</td></tr><tr><td>dLegerGroup</td><td>Dledger Raft Group的名字，建议和brokerName保持一致</td><td>broker-a</td></tr><tr><td>dLegerPeers</td><td>Dledger Group内各节点的端口信息，同一个Group内的各个节点配置必须要保持一致</td><td>n0-127.0.0.1:40911;n1-127.0.0.1:40912;n2-127.0.0.1:40913</td></tr><tr><td>dLegerSelfId</td><td>节点id，必须属于dLegerPeers中的一个，同Group内各个节点要唯一</td><td>n0</td></tr></tbody></table><p>每个数据中心都需要3份配置文件，以conf/dledger/broker-n0.conf 的配置作为基础，我们将搭建以两个节点组成的nameserver集群以及苏州、上海两个dLegerGroup, 下面分别以两个group中的一个节点的配置为例 ：</p><p>苏州：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">## Raft集群名称，所有节点必须一样</span>
<span class="token key attr-name">brokerClusterName</span><span class="token punctuation">=</span><span class="token value attr-value">RaftCluster</span>
<span class="token comment">## 当前数据中心的broker名称，添加数据中心标识，苏州（suzhou）、上海（shanghai）</span>
<span class="token key attr-name">brokerName</span><span class="token punctuation">=</span><span class="token value attr-value">suzhou@broker</span>
<span class="token comment">## 监听端口</span>
<span class="token key attr-name">listenPort</span><span class="token punctuation">=</span><span class="token value attr-value">30911</span>
<span class="token comment">## nameserver地址，多个地址以;分隔</span>
<span class="token key attr-name">namesrvAddr</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.65.237:9876;192.168.65.239:9876</span>
<span class="token comment">## 数据文件存放目录</span>
<span class="token key attr-name">storePathRootDir</span><span class="token punctuation">=</span><span class="token value attr-value">/tmp/rmqstore/node00</span>
<span class="token key attr-name">storePathCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">/tmp/rmqstore/node00/commitlog</span>
<span class="token comment">## 是否启动DLeger</span>
<span class="token key attr-name">enableDLegerCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">## Dledger Raft Group的名字，建议和brokerName保持一致</span>
<span class="token key attr-name">dLegerGroup</span><span class="token punctuation">=</span><span class="token value attr-value">suzhou@broker</span>
<span class="token comment">## DledgerGroup内各节点端口信息，同一个Group内的各个节点配置必须要保持一致，ip地址根据实际情况修改</span>
<span class="token key attr-name">dLegerPeers</span><span class="token punctuation">=</span><span class="token value attr-value">n0-127.0.0.1:40911;n1-127.0.0.1:40912;n2-127.0.0.1:40913</span>
<span class="token comment">## 节点id，必须属于dLegerPeers中的一个，同Group内各个节点要唯一</span>
<span class="token key attr-name">dLegerSelfId</span><span class="token punctuation">=</span><span class="token value attr-value">n0</span>
<span class="token comment"># 发送消息的线程池线程数,建议配置成 Cpu 核数</span>
<span class="token key attr-name">sendMessageThreadPoolNums</span><span class="token punctuation">=</span><span class="token value attr-value">16</span>
<span class="token comment"># broker的ip地址(如果服务器上存在多网卡的情况,建议手动配置,避免获取不到正确的ip信息)</span>
<span class="token key attr-name">brokerIP1</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.65.237</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上海：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">## Raft集群名称，所有节点必须一样</span>
<span class="token key attr-name">brokerClusterName</span><span class="token punctuation">=</span><span class="token value attr-value">RaftCluster</span>
<span class="token comment">## 当前数据中心的broker名称，添加数据中心标识，苏州（suzhou）、上海（shanghai）</span>
<span class="token key attr-name">brokerName</span><span class="token punctuation">=</span><span class="token value attr-value">shanghai@broker</span>
<span class="token comment">## 监听端口</span>
<span class="token key attr-name">listenPort</span><span class="token punctuation">=</span><span class="token value attr-value">30911</span>
<span class="token comment">## nameserver地址，多个地址以;分隔</span>
<span class="token key attr-name">namesrvAddr</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.65.237:9876;192.168.65.239:9876</span>
<span class="token comment">## 数据文件存放目录</span>
<span class="token key attr-name">storePathRootDir</span><span class="token punctuation">=</span><span class="token value attr-value">/tmp/rmqstore/node00</span>
<span class="token key attr-name">storePathCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">/tmp/rmqstore/node00/commitlog</span>
<span class="token comment">## 是否启动DLeger</span>
<span class="token key attr-name">enableDLegerCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">## Dledger Raft Group的名字，建议和brokerName保持一致</span>
<span class="token key attr-name">dLegerGroup</span><span class="token punctuation">=</span><span class="token value attr-value">shanghai@broker</span>
<span class="token comment">## DledgerGroup内各节点端口信息，同一个Group内的各个节点配置必须要保持一致，ip地址根据实际情况修改</span>
<span class="token key attr-name">dLegerPeers</span><span class="token punctuation">=</span><span class="token value attr-value">n0-127.0.0.1:40911;n1-127.0.0.1:40912;n2-127.0.0.1:40913</span>
<span class="token comment">## 节点id，必须属于dLegerPeers中的一个，同Group内各个节点要唯一</span>
<span class="token key attr-name">dLegerSelfId</span><span class="token punctuation">=</span><span class="token value attr-value">n0</span>
<span class="token comment"># 发送消息的线程池线程数,建议配置成 Cpu 核数</span>
<span class="token key attr-name">sendMessageThreadPoolNums</span><span class="token punctuation">=</span><span class="token value attr-value">16</span>
<span class="token comment"># broker的ip地址(如果服务器上存在多网卡的情况,建议手动配置,避免获取不到正确的ip信息)</span>
<span class="token key attr-name">brokerIP1</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.65.239</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-启动nameserver集群" tabindex="-1"><a class="header-anchor" href="#_3-2-启动nameserver集群" aria-hidden="true">#</a> 3.2 启动NameServer集群</h4><p>在192.168.65.237、192.168.65.239两台机器的rocketmq目录下执行命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">nohup</span> <span class="token function">sh</span> bin/mqnamesrv <span class="token operator">&amp;</span>

<span class="token comment">#### 验证namesrv是否启动成功</span>
<span class="token function">tail</span> <span class="token parameter variable">-f</span> nohup.out
The Name Server boot success<span class="token punctuation">..</span>.
<span class="token comment">## 若是namesrv启动出现错误 或者修改配置文件 需要重新启动namesrv</span>
<span class="token comment">## 杀掉旧的 namesrv 再执行启动命令</span>
<span class="token function">sh</span> bin/mqshutdown namesrv
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-启动broker集群" tabindex="-1"><a class="header-anchor" href="#_3-3-启动broker集群" aria-hidden="true">#</a> 3.3 启动Broker集群</h4><p>以苏州中心为例，上海中心同理：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">## 使用当前服务器修改过的对应的配置文件启动broker 这里以broker-n0.conf配置文件为例</span>
<span class="token function">nohup</span> <span class="token function">sh</span> bin/mqbroker <span class="token parameter variable">-c</span> conf/dledger/broker-n0.conf <span class="token operator">&amp;</span>
<span class="token comment">## 在其他节点启用对应的配置文件</span>
<span class="token comment">## nohup sh bin/mqbroker -c conf/dledger/broker-n1.conf &amp;</span>
<span class="token comment">## nohup sh bin/mqbroker -c conf/dledger/broker-n2.conf &amp;</span>

<span class="token comment">## 验证broker集群是否启动成功</span>
<span class="token function">sh</span> bin/mqadmin clusterList <span class="token parameter variable">-n</span> <span class="token number">192.168</span>.65.237:9876

<span class="token comment">## 若是broker启动出现错误 或者修改配置文件 需要重新启动broker</span>
<span class="token comment">## 杀掉旧的 Broker 再执行启动命令</span>
<span class="token function">sh</span> bin/mqshutdown broker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-启动rocketmq-console" tabindex="-1"><a class="header-anchor" href="#_3-4-启动rocketmq-console" aria-hidden="true">#</a> 3.4 启动RocketMQ Console</h4><p>随便选择一台机器，以192.168.65.237为例，上传rocketmq-console-ng-1.0.1.jar</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">nohup</span> <span class="token function">java</span> <span class="token parameter variable">-server</span> <span class="token parameter variable">-Xmx512m</span> <span class="token parameter variable">-Xms256m</span> <span class="token parameter variable">-jar</span> rocketmq-console-ng-1.0.1.jar <span class="token parameter variable">--server.port</span><span class="token operator">=</span><span class="token number">8089</span> --
<span class="token assign-left variable">rocketmq.config.namesrvAddr</span><span class="token operator">=</span><span class="token number">192.168</span>.65.237:9876<span class="token punctuation">;</span><span class="token number">192.168</span>.65.239:9876 <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>浏览器访问 192.168.65.237:8089</p><figure><img src="`+l+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',32)])])}const u=a(o,[["render",p],["__file","rocketmq-ha.html.vue"]]);export{u as default};
